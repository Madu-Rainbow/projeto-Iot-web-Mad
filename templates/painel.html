{% extends "base.html" %}

{% block title %}Painel Ar Condicionado{% endblock %}
{% block extra_js %}
<script>
    function formatTime(totalSeconds) {
        // Garante que √© um n√∫mero
        totalSeconds = parseInt(totalSeconds); 
        
        const minutes = Math.floor(totalSeconds / 60);
        const seconds = totalSeconds % 60;
        
        // Retorna a string formatada: 1 min 05 seg
        return `${minutes} min ${seconds < 10 ? '0' : ''}${seconds} seg`;
    }

    function updateTimer() {
        const timerElement = document.getElementById('tempo-ativo');

        // Se o elemento n√£o existe (ou seja, o AR est√° desligado), pare.
        if (!timerElement) {
            return;
        }

        // Pega o n√∫mero atual de segundos
        let currentSeconds = parseInt(timerElement.getAttribute('data-start-seconds'));
        
        // 1. Incrementa o contador
        currentSeconds += 1;
        
        // 2. Atualiza o texto na tela
        timerElement.textContent = formatTime(currentSeconds);

        // 3. Atualiza o atributo de dados para a pr√≥xima itera√ß√£o
        timerElement.setAttribute('data-start-seconds', currentSeconds);
    }

    // Inicializa a contagem assim que a p√°gina carrega
    document.addEventListener('DOMContentLoaded', function() {
        const timerElement = document.getElementById('tempo-ativo');
        
        if (timerElement) {
            // Define o valor inicial formatado (assim o usu√°rio n√£o v√™ um n√∫mero bruto)
            let initialSeconds = parseInt(timerElement.getAttribute('data-start-seconds'));
            timerElement.textContent = formatTime(initialSeconds);
            
            // Inicia o timer para atualizar a cada 1 segundo (1000ms)
            setInterval(updateTimer, 1000);
        }
    });

</script>
{% endblock %}

{% block extra_css %}
<style>
    /* Estilos customizados para o painel */
    .ac-painel {
        max-width: 500px; /* Limita a largura do painel principal */
        margin: 50px auto;
        padding: 0;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        border-radius: 15px;
        overflow: hidden;
    }
    .ac-status-badge {
        font-size: 1.1em;
        padding: 0.5em 1.5em;
        border-radius: 20px;
        font-weight: bold;
    }
    .temp-display {
        font-size: 4.5rem; /* Temperatura em destaque */
        font-weight: 300;
        margin-bottom: 0.1em;
    }
    .temp-controls .btn {
        width: 60px;
        height: 60px;
        border-radius: 50%; /* Bot√µes redondos */
        font-size: 1.5rem;
    }
    .card-header-power {
        background-color: #343a40 !important; /* Fundo escuro para cabe√ßalho */
        border-bottom: none;
    }
</style>
{% endblock %}

{% block content %}

{% if ar %}
    <div class="ac-painel card border-0">
        
        <div class="card-header card-header-power text-white py-3 d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-snowflake me-2"></i> Ar-Condicionado
            </h5>
            <form method="post" action="{% url 'alternar' %}">
                {% csrf_token %}
                <button type="submit" 
                        class="btn btn-sm {% if ar.ligado %}btn-danger{% else %}btn-success{% endif %}">
                    <i class="fas {% if ar.ligado %}fa-power-off{% else %}fa-bolt{% endif %} me-1"></i>
                    {% if ar.ligado %}Desligar{% else %}Ligar{% endif %}
                </button>
            </form>
        </div>

        <div class="card-body p-4">
            
            <div class="text-center mb-4">
                <p class="text-muted mb-1">Temperatura Atual</p>
                <div class="temp-display text-primary">
                    {{ ar.temperatura }}<small style="font-size: 0.5em;">¬∞C</small>
                </div>
                
                <div class="d-flex justify-content-center gap-3 temp-controls">
    
                <form method="post" action="{% url 'diminuir_with_pk' ar.pk %}"> 
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger" 
                            {% if not ar.ligado %}disabled{% endif %}>
                        <i class="fas fa-minus"></i>
                    </button>
                </form>
                
                <form method="post" action="{% url 'aumentar_with_pk' ar.pk %}">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-success" 
                            {% if not ar.ligado %}disabled{% endif %}>
                        <i class="fas fa-plus"></i>
                    </button>
                </form>
            </div>
            </div>

            <hr class="my-4">

            <div class="row text-center">
                
                <div class="col-sm-6 mb-3">
                    <h6 class="text-muted small fw-bold mb-2">MODO ATUAL</h6>
                    <div class="card bg-light border-secondary p-2">
                        <form method="post" action="{% url 'alterar_modo_with_pk' ar.pk %}"> 
                            {% csrf_token %}
                            <select name="modo" class="form-select form-select-sm mb-2"
                                    {% if not ar.ligado %}disabled{% endif %}>
                                <option value="Frio" {% if ar.modo == "Frio" %}selected{% endif %}>‚ùÑÔ∏è Frio</option>
                                <option value="Quente" {% if ar.modo == "Quente" %}selected{% endif %}>üî• Quente</option>
                                <option value="Ventilar" {% if ar.modo == "Ventilar" %}selected{% endif %}>üí® Ventilar</option>
                                <option value="Autom√°tico" {% if ar.modo == "Autom√°tico" %}selected{% endif %}>‚öôÔ∏è Autom√°tico</option>
                            </select>
                            <button type="submit" class="btn btn-sm btn-outline-info w-100" 
                                    {% if not ar.ligado %}disabled{% endif %}>
                                Aplicar
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-sm-6 mb-3">
    <h6 class="text-muted small fw-bold mb-2">STATUS E TEMPO</h6>
    <div class="card p-3 border-{% if ar.ligado %}success{% else %}danger{% endif %}">
        {% if ar.ligado %}
            <span class="ac-status-badge bg-success text-white">
                <i class="fas fa-check-circle me-1"></i> OPERANDO
            </span>
            <small class="mt-2 text-muted">
                Tempo ativo:
                <span class="fw-bold text-dark" id="tempo-ativo" 
                      data-start-seconds="{{ tempo_ligado_seconds }}">
                    </span>
            </small>
        {% else %}
            <span class="ac-status-badge bg-danger text-white">
                <i class="fas fa-times-circle me-1"></i> DESATIVADO
            </span>
        {% endif %}
    </div>
</div>

            </div>
            
        </div>
    </div>
{% else %}
    <div class="container my-5">
        <div class="alert alert-info text-center" role="alert">
            <h4 class="alert-heading"><i class="fas fa-cogs me-2"></i>Configura√ß√£o Necess√°ria</h4>
            <p>Nenhum aparelho de ar condicionado encontrado no sistema. Por favor, verifique os dispositivos cadastrados.</p>
        </div>
    </div>
{% endif %}

{% endblock %}